# redis 事件学习

### redis是单线程的吗？
   - redis对数据事件的处理是单线程的。但是他也有其他线程，比如用于同步，用于持久化的。
### redis为什么这么快？
   - 纯内存数据库，对数据的读写等处理都在内存中。
   - 单线程操作，无需像多线程上下文切换，减少线程间竞争资源的消耗（无锁操作）。
   - 使用IO多路复用技术，包装了select、epoll、evport和kqueue函数库。在源码中对应的文件为ae_select.c 、 ae_epoll.c 、ae_evport.c 、 ae_kqueue.c。在ae.c中定义了宏，默认选择性能高的方案，select是所有系统都支持的，用它保底。
### redis事件的分类
   - redis服务器是一个事件驱动的程序，服务器处理的时间分为两类：
    1. 文件事件
        1. AE_READABLE事件 (读事件)
        2. AE_WRITABLE事件 (写事件)
    2. 时间事件
        1. 定时事件 ： 定时事件只在指定的时间达到一次；
        2. 周期性事件：周期事件每隔一段事件到达一次。
    - 文件事件和时间事件之间为合作关系，服务器会轮流处理这两种事件；不会出现抢占。
### 文件事件
   - 每当一个套接字贮备好连接应答、写入、读取关闭等操作的时候就会产生一个文件事件。
    也就是说客户端服务器发送连接、读、写命令都属于文件事件。
  - ### 文件事件处理器（重点）
    - Redis基于Reactor模式开发了自己的网络时间处理器，称为文件事件处理器。
    文件事件处理器组成：
        1. 套接字（socket）
        2. IO多路复用程序
        3. 文件事件分派器 dispatcher
        4. 事件处理器
    过程：
    1. 套接字产生事件后->通过IO多路复用程序入队到一个队列里面
    2. 通过这个队列，以有序、同步、每次一个套接字的方式向文件事件分派器传送。（注意同步...单线程！！！）
    只有上一个套接字处理完毕后，I/O多路复用程序才会向文件事件分派器派发下一个套接字。
    3. 事件处理器处理不同的事件，常见如：连接应答处理器、命令请求处理器和回复处理器。
    
    - 建议查看相关源码！
### 时间事件

   - 时间事件指的是定时执行的任务，如serverCron函数。定时事件是在指定时间之后执行一次。周期性事件每隔一段时间会执行一次。
    redis服务器将所有的时间事件都放在一个无序列表中，每当时间事件执行器运行时，就会遍历整个链表，查找已到达的时间事件，并调用相应的处理事件。
   - #### serverCron函数
        - 每隔100毫秒执行一次，更新系统缓存时间，清理数据库中过期的键值，关闭连接失效的客户端，进行AOF或RDB持久化操作等。
   -  #### Redis事件调度和执行规则
        
        - 启动服务器->是否关闭服务器--否-->等待文件事件产生->处理产生的文件事件->处理已达到的时间事件->是否关闭服务器
        
        - 服务器启动之后会等待文件事件的产生，文件事件随机参数的，所以当没有任何文件事件到达时，服务器将会一直等待处理文件到达。
        当有文件事件到达时，redis执行完文件事件之后，在判断时间事件是否到达，直到满足时间事件的执行条件。
        
        - 因为时间事件总是在文件时间执行完之后才能执行，并且redis是单线程处理，
        事件直接不会出现抢占，所以时间事件的实际处理时间会比设定的晚一点。
        